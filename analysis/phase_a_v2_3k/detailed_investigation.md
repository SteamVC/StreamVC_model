# Phase A-v2 è©³ç´°èª¿æŸ»å ±å‘Š

**æ—¥ä»˜**: 2025-11-07
**èª¿æŸ»ç¯„å›²**: Phase A-v2 @ 3Kå¤±æ•—ã®å¾¹åº•åˆ†æã€VQæ­£è¦åŒ–ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹èª¿æŸ»

---

## TL;DR

### ä¸»è¦ãªç™ºè¦‹

1. âŒ **Phase A-v2ã¯äºˆæƒ³ã¨é€†ã®çµæœ**:
   - out_proj norm: **0.463** (Phase 1ã®**11å€å¤§ãã„**: 0.042)
   - ã—ã‹ã— Audio RMS: **0.0044** (Phase 1: 0.080ã®**5%**)

2. âœ… **Phase 1æˆåŠŸã®ç†ç”±ãŒåˆ¤æ˜**:
   - **out_projãŒæ¥µç«¯ã«å°ã•ã„**(0.042)ã“ã¨ã§ã€é€†ã«ã‚¹ã‚±ãƒ¼ãƒ«ãŒå®‰å®š
   - ã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹é€ : `rvq â†’ out_proj` (2å±¤ã®ã¿)
   - æ­£è¦åŒ–ã®å½±éŸ¿ãŒç›´æ¥out_projã«å±Šã

3. ğŸ”¬ **VQæ­£è¦åŒ–ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹åˆ¤æ˜**:
   - **DACæ–¹å¼ï¼ˆL2æ­£è¦åŒ–ï¼‰ãŒç¾åœ¨ã®ä¸»æµ**
   - ã‚³ãƒ¼ãƒ‰ãƒ–ãƒƒã‚¯åˆ©ç”¨ç‡å‘ä¸Šã€è¨“ç·´å®‰å®šæ€§å‘ä¸Šã§å®Ÿè¨¼æ¸ˆã¿
   - StreamVCã®Z-scoreæ­£è¦åŒ–ã¯éæ¨™æº–

4. âš ï¸ **æ ¹æœ¬åŸå› ã®å†å®šç¾©**:
   - å•é¡Œã¯ã€Œæ­£è¦åŒ–ã§ã‚¹ã‚±ãƒ¼ãƒ«ç ´å£Šã€ã§ã¯ãªã
   - **ã€Œæ­£è¦åŒ– + è¤‡é›‘ãªå±¤æ§‹é€  + ä¸é©åˆ‡ãªåˆæœŸåŒ–ã€ã®çµ„ã¿åˆã‚ã›**

---

## 1. Phase A-v2 æ™‚ç³»åˆ—è©³ç´°è§£æ

### 1.1 Audio RMSã®å´©å£Šãƒ‘ã‚¿ãƒ¼ãƒ³

```
åŒºé–“        Audio RMS   å¤‰åŒ–ç‡
0-500:      0.487      -
500-1K:     0.248      -49%  â† æ€¥æ¿€ãªæ¸›å°‘é–‹å§‹
1K-1.5K:    0.134      -46%  â† åŠ é€Ÿ
1.5K-2K:    0.048      -64%  â† å´©å£Š
2K-2.5K:    0.044      -8%   â† ã»ã¼åº•
2.5K-3K:    0.015      -66%  â† ã•ã‚‰ã«æ‚ªåŒ–

Overall:    0.527 â†’ 0.005 (-99.1%)
```

**è¦³å¯Ÿ**:
- 500-1500 stepã§æœ€ã‚‚æ€¥æ¿€ã«æ¸›å°‘
- 1.5Kä»¥é™ã¯ã»ã¼å´©å£ŠçŠ¶æ…‹
- **æŒ‡æ•°é–¢æ•°çš„æ¸›è¡°**ï¼ˆä¸€å®šç‡ã§ã®æ¸›å°‘ã§ã¯ãªã„ï¼‰

### 1.2 Perplexity Q0ã®æ¨ç§»

```
åŒºé–“        Perplexity  å¤‰åŒ–ç‡
0-500:      25.1       -
500-1K:     22.6       -10%
1K-1.5K:    14.1       -38%  â† æ€¥æ¸›
1.5K-2K:    10.4       -26%
2K-2.5K:    5.3        -49%  â† ã‚³ãƒ¼ãƒ‰å´©å£Š
2.5K-3K:    3.9        -26%

Overall:    27.4 â†’ 5.0 (-81.8%)
```

**è¦³å¯Ÿ**:
- Audio RMSã‚ˆã‚Šé…ã‚Œã¦ã‚³ãƒ¼ãƒ‰å´©å£ŠãŒç™ºç”Ÿ
- 1.5Kä»¥é™ã§é¡•è‘—
- æœ€çµ‚çš„ã«ç›®æ¨™å€¤(â‰¥8)ã‚’å¤§ããä¸‹å›ã‚‹

### 1.3 out_proj normã®åŠ£åŒ–

```
åŒºé–“        out_proj norm  å¤‰åŒ–ç‡
0-500:      0.562         -
500-1K:     0.535         -5%
1K-1.5K:    0.508         -5%
1.5K-2K:    0.487         -4%
2K-2.5K:    0.469         -4%
2.5K-3K:    0.464         -1%

Overall:    0.566 â†’ 0.463 (-18.2%)
```

**è¦³å¯Ÿ**:
- **ç·šå½¢çš„ãªæ¸›å°‘**ï¼ˆæŒ‡æ•°çš„ã§ã¯ãªã„ï¼‰
- æ¸›å°‘ç‡ã¯ä¸€å®šï¼ˆ~4-5%/500stepï¼‰
- Weight decayã®å½±éŸ¿ï¼Ÿï¼ˆãŸã ã—weight_decay=0ã«è¨­å®šæ¸ˆã¿ï¼‰

### 1.4 final_conv normã®å®‰å®šæ€§

```
åŒºé–“        final_conv norm  å¤‰åŒ–ç‡
0-500:      6.322           -
500-1K:     6.301           -0.3%
1K-1.5K:    6.282           -0.3%
1.5K-2K:    6.268           -0.2%
2K-2.5K:    6.264           -0.1%
2.5K-3K:    6.263           -0.0%

Overall:    6.325 â†’ 6.263 (-1.0%)
```

**è¦³å¯Ÿ**:
- **éå¸¸ã«å®‰å®š**ï¼ˆ-1%ã®ã¿ï¼‰
- IdentityåˆæœŸåŒ–ãŒæ­£ã—ãæ©Ÿèƒ½
- final_convã¯å•é¡Œã§ã¯ãªã„

### 1.5 RVQ Lossã®å¢—åŠ 

```
åŒºé–“        RVQ Loss    å¤‰åŒ–ç‡
0-500:      1.295      -
500-1K:     1.218      -6%
1K-1.5K:    1.229      +1%
1.5K-2K:    1.123      -9%
2K-2.5K:    2.044      +82%  â† æ€¥å¢—
2.5K-3K:    1.988      -3%

Overall:    1.175 â†’ 1.967 (+67.3%)
```

**è¦³å¯Ÿ**:
- 2Kä»¥é™ã§æ€¥å¢—
- ã‚³ãƒ¼ãƒ‰å´©å£Šã¨åŒæœŸ
- é‡å­åŒ–èª¤å·®ãŒå¢—å¤§

### 1.6 RMS Lossã®åæŸï¼ˆã—ã‹ã—ç„¡æ„å‘³ï¼‰

```
åŒºé–“        RMS Loss    å¤‰åŒ–ç‡
0-500:      0.165      -
500-1K:     0.031      -81%  â† æ€¥é€Ÿã«åæŸ
1K-1.5K:    0.003      -92%
1.5K-2K:    0.001      -67%
2K-2.5K:    0.007      +567% â† åè»¢
2.5K-3K:    0.004      -41%

Overall:    0.199 â†’ 0.005 (-97.7%)
```

**è¦³å¯Ÿ**:
- RMS Lossã¯åæŸã—ã¦ã„ã‚‹
- ã—ã‹ã—å®Ÿéš›ã®Audio RMSã¯å´©å£Š
- **Lossã¨å®Ÿéš›ã®æŒ¯å¹…ãŒä¹–é›¢**

---

## 2. Phase 1 vs Phase A-v2 å¾¹åº•æ¯”è¼ƒ

### 2.1 ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¯”è¼ƒ

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | Phase 1 @ 6K | Phase A-v2 @ 3K | æ¯”ç‡ |
|-----------|--------------|-----------------|------|
| **out_proj norm** | **0.042** | **0.463** | **11.0x** |
| out_proj bias | -0.029 | -0.099 | 3.4x |
| Codebook Q0 norm | 202.2 | 202.2 | 1.0x |
| Codebook Q1 norm | 201.8 | 201.8 | 1.0x |
| pre_rvq_conv norm | 3.689 | 3.713 | 1.0x |
| **final_conv norm** | - | **6.263** | N/A |
| **post_scale** | - | **[0.91, 0.97, ...]** | N/A |

**é©šãã¹ãç™ºè¦‹**:
- Phase A-v2ã®out_proj normã¯**Phase 1ã®11å€ã‚‚å¤§ãã„**
- ãã‚Œã§ã‚‚Audio RMSã¯**1/18**ï¼ˆPhase 1: 0.080, Phase A-v2: 0.0044ï¼‰
- **ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚µã‚¤ã‚º â‰  å‡ºåŠ›æŒ¯å¹…**

### 2.2 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®é•ã„

**Phase 1**:
```
Input (normalized, std=1.0)
  â†“
RVQ (8 quantizers)
  â†“
out_proj (norm=0.042, éå¸¸ã«å°ã•ã„)
  â†“
Audio (RMS=0.080)
```

**Phase A-v2**:
```
Input (normalized, std=1.0)
  â†“
RVQ (8 quantizers)
  â†“
post_scale/post_bias (per-quantizer, å­¦ç¿’ä¸­)
  â†“
final_conv (norm=6.26, IdentityåˆæœŸåŒ–)
  â†“
out_proj (norm=0.463, Phase 1ã®11å€)
  â†“
Audio (RMS=0.0044)
```

**Phase A-v2ã®è¿½åŠ å±¤**:
1. `post_scale` (8å€‹ã®ã‚¹ã‚«ãƒ©ãƒ¼, å­¦ç¿’å¯èƒ½)
2. `post_bias` (8å€‹ã®ã‚¹ã‚«ãƒ©ãƒ¼, å­¦ç¿’å¯èƒ½)
3. `final_conv` (40x40 1x1 Conv, IdentityåˆæœŸåŒ–)

### 2.3 ãªãœPhase 1ã¯æˆåŠŸã—ãŸã®ã‹

**ä»®èª¬1: æ¥µç«¯ã«å°ã•ã„out_projãŒé€†ã«å®‰å®š**

```python
# Phase 1ã®out_proj norm: 0.042
# åˆæœŸåŒ–æ™‚ã®Kaiming uniformæœŸå¾…å€¤: sqrt(2/fan_in) â‰ˆ 0.2-0.3
# â†’ å­¦ç¿’ä¸­ã«**ç¸®å°**ã—ã¦ã„ã‚‹ï¼ˆ-80%ä»¥ä¸Šï¼‰

# ãªãœç¸®å°ï¼Ÿ
# 1. æ­£è¦åŒ–ã•ã‚ŒãŸRVQå‡ºåŠ›ï¼ˆstdâ‰ˆ1.0ï¼‰ã‚’å—ã‘å–ã‚‹
# 2. ç›®æ¨™audioï¼ˆRMSâ‰ˆ0.075ï¼‰ã«å†™åƒã™ã‚‹å¿…è¦
# 3. â†’ out_projã¯å°ã•ããªã‚‹æ–¹å‘ã«å­¦ç¿’ã•ã‚Œã‚‹

# ãªãœå®‰å®šï¼Ÿ
# 1. RVQå‡ºåŠ›ã®ã‚ãšã‹ãªå¤‰å‹•ãŒå¢—å¹…ã•ã‚Œãªã„ï¼ˆå°ã•ã„weightï¼‰
# 2. ã‚·ãƒ³ãƒ—ãƒ«ãª1å±¤ã®ã¿ â†’ å‹¾é…ãŒç›´æ¥å±Šã
# 3. ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´ã®è²¬ä»»ãŒout_proj 1å±¤ã«é›†ä¸­
```

**ä»®èª¬2: å±¤ã®æ•°ãŒå°‘ãªã„ã“ã¨ã®åˆ©ç‚¹**

```
Phase 1:
  RVQ â†’ out_proj
  å‹¾é…: âˆ‚L/âˆ‚out_proj = âˆ‚L/âˆ‚audio Ã— âˆ‚audio/âˆ‚out_proj
  â†’ ç›´æ¥çš„ã€æ˜ç¢º

Phase A-v2:
  RVQ â†’ post_scale â†’ final_conv â†’ out_proj
  å‹¾é…: âˆ‚L/âˆ‚out_proj = âˆ‚L/âˆ‚audio Ã— âˆ‚audio/âˆ‚out_proj Ã— âˆ‚out_proj/âˆ‚final_conv Ã— ...
  â†’ é–“æ¥çš„ã€å¸Œé‡ˆã•ã‚Œã‚‹
```

**ä»®èª¬3: RMS LossãŒãªã„åˆ©ç‚¹**

```python
# Phase 1ã®æå¤±é–¢æ•°:
total_loss = content_ce + stft + l1 + rvq
# â†’ ã‚¹ã‚±ãƒ¼ãƒ«ã«ç›´æ¥è¨€åŠã™ã‚‹é …ãªã—
# â†’ ãƒ¢ãƒ‡ãƒ«ã¯ã€ŒéŸ³è³ªã€ã ã‘ã‚’æœ€é©åŒ–
# â†’ çµæœçš„ã«ã‚¹ã‚±ãƒ¼ãƒ«ã‚‚é©åˆ‡ã«å­¦ç¿’

# Phase A-v2ã®æå¤±é–¢æ•°:
total_loss = content_ce + stft + l1 + rvq + rms + multiband_rms
# â†’ RMSãŒæ˜ç¤ºçš„ã«ç›£ç£
# â†’ ã—ã‹ã—RMS Lossã®å‹¾é…ãŒä»–ã‚ˆã‚Šå°ã•ã„
# â†’ ç„¡è¦–ã•ã‚Œã‚‹ or é€†åŠ¹æœ
```

### 2.4 Lossæ¨ç§»ã®æ¯”è¼ƒ

| Loss | Phase 1 (å¾ŒåŠ) | Phase A-v2 (å¾ŒåŠ) | æ¯”è¼ƒ |
|------|---------------|------------------|------|
| STFT | 2.16 | 2.90 | Phase 1ãŒè‰¯ã„ |
| RVQ | 1.82 | 1.54 | Phase A-v2ãŒè‰¯ã„ |
| Perplexity | 7.9 | 12.5 | Phase A-v2ãŒè‰¯ã„ |

**è¦³å¯Ÿ**:
- Phase A-v2ã¯**RVQ Lossã€Perplexityã§å„ªä½**
- ã—ã‹ã—STFT Lossã¯**Phase 1ãŒè‰¯ã„**
- **éŸ³è³ªã¨ã‚³ãƒ¼ãƒ‰ãƒ–ãƒƒã‚¯åˆ©ç”¨ç‡ã¯ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã®å¯èƒ½æ€§**

---

## 3. VQæ­£è¦åŒ–ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹èª¿æŸ»çµæœ

### 3.1 ä¸»è¦ãƒ¢ãƒ‡ãƒ«ã®æ­£è¦åŒ–æˆ¦ç•¥

| ãƒ¢ãƒ‡ãƒ« | å…¥åŠ›æ­£è¦åŒ– | Codebookæ­£è¦åŒ– | ã‚¹ã‚±ãƒ¼ãƒ«ä¿å­˜ | ä¸»ãªç›®çš„ |
|--------|----------|--------------|------------|---------|
| **DAC** | **L2æ­£è¦åŒ–** | **L2æ­£è¦åŒ–** | ãªã— | Codebookåˆ©ç”¨ç‡ |
| **EnCodec** | RMSæ­£è¦åŒ– | ãªã— | ã‚ã‚Šï¼ˆæ˜ç¤ºï¼‰ | æŒ¯å¹…ä¿å­˜ |
| **SoundStream** | ãªã— | ãªã— | N/A | ã‚·ãƒ³ãƒ—ãƒ«ã• |
| **StreamVC** | **Z-score** | **ãªã—** | å­¦ç¿’å¯èƒ½ | (ç‹¬è‡ª) |

### 3.2 DACæ–¹å¼ï¼ˆL2æ­£è¦åŒ–ï¼‰ã®åˆ©ç‚¹

**å®Ÿè£…ä¾‹**:
```python
# ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€å‡ºåŠ›ã‚’L2æ­£è¦åŒ–ï¼ˆå˜ä½è¶…çƒé¢ã«å°„å½±ï¼‰
z_e = F.normalize(encodings, p=2, dim=-1)  # ||z_e|| = 1

# ã‚³ãƒ¼ãƒ‰ãƒ–ãƒƒã‚¯ã‚‚L2æ­£è¦åŒ–
codebook = F.normalize(codebook, p=2, dim=-1)  # ||cb|| = 1

# è·é›¢è¨ˆç®—ï¼ˆã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦ã¨ç­‰ä¾¡ï¼‰
dist = z_e @ codebook.t()  # ç¯„å›²: [-1, 1]
indices = dist.argmax(dim=-1)
```

**åˆ©ç‚¹**:
1. **è¨“ç·´å®‰å®šæ€§**: å‹¾é…ã®å¤§ãã•ãŒäºˆæ¸¬å¯èƒ½ï¼ˆImproved VQGANè«–æ–‡ã§å®Ÿè¨¼ï¼‰
2. **Codebookåˆ©ç”¨ç‡**: Dead codeså‰Šæ¸›ï¼ˆå…¨ã‚³ãƒ¼ãƒ‰ãŒç­‰è·é›¢ã«ãªã‚Šã‚„ã™ã„ï¼‰
3. **å‹¾é…ã‚¯ãƒªãƒƒãƒ”ãƒ³ã‚°ä¸è¦**: ãƒ™ã‚¯ãƒˆãƒ«ãŒå˜ä½çƒé¢ã«åˆ¶é™ã•ã‚Œã‚‹

**StreamVCã¨ã®é•ã„**:
```python
# StreamVC (ç¾åœ¨): Z-scoreæ­£è¦åŒ–
x = (x - x.mean(dim=-1, keepdim=True)) / x.std(dim=-1, keepdim=True)
# â†’ mean=0, std=1 ã ãŒã€ãƒãƒ«ãƒ ã¯å¯å¤‰

# DAC: L2æ­£è¦åŒ–
x = F.normalize(x, p=2, dim=-1)
# â†’ ãƒãƒ«ãƒ =1 å›ºå®šã€æ–¹å‘ã®ã¿
```

### 3.3 EnCodecæ–¹å¼ï¼ˆã‚¹ã‚±ãƒ¼ãƒ«æ˜ç¤ºä¿å­˜ï¼‰ã®åˆ©ç‚¹

**å®Ÿè£…ä¾‹**:
```python
# ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ™‚
scale = audio.pow(2).mean().sqrt() + 1e-8
normalized = audio / scale
codes = quantize(encode(normalized))

# ãƒ‡ã‚³ãƒ¼ãƒ‰æ™‚
audio = decode(codes) * scale  # ã‚¹ã‚±ãƒ¼ãƒ«å¾©å…ƒ
```

**åˆ©ç‚¹**:
1. **æŒ¯å¹…å®Œå…¨ä¿å­˜**: å…ƒã®éŸ³å£°ã‚¹ã‚±ãƒ¼ãƒ«ã‚’ä¿è¨¼
2. **æ¨è«–å®‰å®šæ€§**: ã‚¹ã‚±ãƒ¼ãƒ«ãŒå­¦ç¿’ã«ä¾å­˜ã—ãªã„
3. **ãƒ“ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆ**: è¿½åŠ 4 bytes/frameã®ã¿

**æ¬ ç‚¹**:
- è¿½åŠ ãƒ¡ãƒ¢ãƒªï¼ˆã‚¹ã‚±ãƒ¼ãƒ«ä¿‚æ•°ã®ä¿å­˜ï¼‰
- ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°æ™‚ã®å®Ÿè£…è¤‡é›‘åŒ–

### 3.4 StreamVCå®Ÿè£…ã®ç‰¹ç•°æ€§

**ç‹¬è‡ªã®å¼·ã¿**:
1. **Per-quantizer ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´**: ä»–ãƒ¢ãƒ‡ãƒ«ã«ãªã„
2. **å¤šå±¤çš„ã‚¹ã‚±ãƒ¼ãƒ«å¯¾ç­–**: post_scale â†’ final_conv â†’ out_proj â†’ RMS loss
3. **Progressive RVQ**: æ®µéšçš„ãªé‡å­åŒ–å™¨è¿½åŠ 

**éæ¨™æº–ãªç‚¹**:
1. **Z-scoreæ­£è¦åŒ–**: ä¸»æµã§ã¯ãªã„ï¼ˆDAC=L2, EnCodec=RMSï¼‰
2. **Codebookéæ­£è¦åŒ–**: å…¥åŠ›ã¯æ­£è¦åŒ–ã™ã‚‹ãŒCodebookã¯éæ­£è¦åŒ–
3. **å­¦ç¿’å¯èƒ½ã‚¹ã‚±ãƒ¼ãƒ«**: æ˜ç¤ºçš„ä¿å­˜ã§ã¯ãªãæš—é»™çš„å­¦ç¿’

---

## 4. æ ¹æœ¬åŸå› ã®å†å®šç¾©

### 4.1 å½“åˆã®ä»®èª¬ï¼ˆèª¤ã‚Šï¼‰

**Phase A-v2å¤±æ•—åˆ†æã§ã®ä»®èª¬**:
```
åŸå› : Pre-RVQæ­£è¦åŒ–ãŒã‚¹ã‚±ãƒ¼ãƒ«æƒ…å ±ã‚’ç ´å£Š
  â†“
è§£æ±ºç­–: ã‚¹ã‚±ãƒ¼ãƒ«æ˜ç¤ºä¿å­˜ï¼ˆEnCodecæ–¹å¼ï¼‰
```

### 4.2 æ–°ã—ã„ç†è§£ï¼ˆæ­£ã—ã„ï¼‰

**å®Ÿéš›ã®åŸå› **:
```
æ­£è¦åŒ–ãã®ã‚‚ã®ã¯å•é¡Œã§ã¯ãªã„
  â†“
å•é¡Œ: æ­£è¦åŒ– + è¤‡é›‘ãªå±¤æ§‹é€  + åˆæœŸåŒ–ãƒŸã‚¹ãƒãƒƒãƒ
  â†“
Phase 1ãŒæˆåŠŸã—ãŸç†ç”±:
  - ã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹é€ ï¼ˆrvq â†’ out_proj ã®ã¿ï¼‰
  - out_projãŒæ¥µç«¯ã«å°ã•ã„ï¼ˆ0.042ï¼‰
  - å‹¾é…ãŒç›´æ¥å±Šã
  - RMS LossãŒãªã„ï¼ˆé€†ã«è‰¯ã„ï¼Ÿï¼‰
```

### 4.3 Phase A-v2ã§ä½•ãŒèµ·ããŸã‹

**Forward Passè©³ç´°**:

```python
# Step 1: æ­£è¦åŒ–ï¼ˆdecoder.py:126-127ï¼‰
x_for_rvq = (x - mean) / std  # std=1.0ã«å¼·åˆ¶
# â†’ ã‚¹ã‚±ãƒ¼ãƒ«æƒ…å ±æ¶ˆå¤±ï¼ˆã“ã‚Œã¯æƒ³å®šé€šã‚Šï¼‰

# Step 2: RVQé‡å­åŒ–
quantized = rvq(x_for_rvq)  # std â‰ˆ 0.84 (é‡å­åŒ–èª¤å·®ã§æ¸›å°‘)

# Step 3: post_scaleé©ç”¨
quantized_scaled = quantized * post_scale[0]  # 0.91
# â†’ std â‰ˆ 0.84 * 0.91 = 0.76

# Step 4: final_conv (IdentityåˆæœŸåŒ–)
quantized_final = final_conv(quantized_scaled)  # diagonal=0.98
# â†’ std â‰ˆ 0.76 * 0.98 = 0.75 (ã»ã¼ç¶­æŒ)

# Step 5: out_proj
audio = out_proj(quantized_final)  # norm=0.463
# â†’ std â‰ˆ 0.75 * 0.463 = 0.35 (æœŸå¾…å€¤)
# ã—ã‹ã—å®Ÿéš›ã¯ 0.0044 â† **100å€å°ã•ã„ï¼**
```

**ãªãœout_projã§å´©å£Šã™ã‚‹ã®ã‹**:

```python
# out_proj ã®æœŸå¾…ã•ã‚Œã‚‹æŒ™å‹•:
# å…¥åŠ›: (B, 40, T), stdâ‰ˆ0.75
# å‡ºåŠ›: (B, 1, T), RMSâ‰ˆ0.075 (ç›®æ¨™)
# â†’ weight norm â‰ˆ 0.075 / 0.75 = 0.1 ãŒé©åˆ‡

# å®Ÿéš›ã®out_proj:
# weight norm = 0.463 (æœŸå¾…å€¤ã®4.6å€)
# ãªã®ã«å‡ºåŠ› RMS = 0.0044 (æœŸå¾…å€¤ã®1/17)

# çŸ›ç›¾ã®ç†ç”±:
# 1. out_projã®weightã¯å¤§ãã„ï¼ˆ0.463ï¼‰
# 2. ã—ã‹ã—å‡ºåŠ›ã¯å°ã•ã„ï¼ˆ0.0044ï¼‰
# 3. â†’ å…¥åŠ›ã®quantized_finalãŒæƒ³å®šã‚ˆã‚Šé¥ã‹ã«å°ã•ã„ï¼Ÿ
```

### 4.4 çœŸã®çŠ¯äºº: å¤šå±¤æ§‹é€ ã«ã‚ˆã‚‹å‹¾é…å¸Œé‡ˆ

**Phase 1**:
```
Loss â†’ âˆ‚L/âˆ‚audio â†’ âˆ‚audio/âˆ‚out_proj â†’ out_projã«ç›´æ¥ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
```

**Phase A-v2**:
```
Loss â†’ âˆ‚L/âˆ‚audio â†’ âˆ‚audio/âˆ‚out_proj â†’ âˆ‚out_proj/âˆ‚final_conv â†’ âˆ‚final_conv/âˆ‚post_scale â†’ RVQ

å‹¾é…ãŒ4å±¤ã‚’çµŒç”±:
1. out_proj (å­¦ç¿’å¯èƒ½)
2. final_conv (å­¦ç¿’å¯èƒ½)
3. post_scale (å­¦ç¿’å¯èƒ½)
4. RVQ codebooks (å­¦ç¿’å¯èƒ½)

â†’ å„å±¤ãŒå‹¾é…ã‚’å¸åãƒ»å¤‰æ›
â†’ ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´ã®è²¬ä»»ãŒåˆ†æ•£
â†’ ã©ã®å±¤ã‚‚ååˆ†ã«å­¦ç¿’ã•ã‚Œãªã„
```

**è¨¼æ‹ **:
- post_scale: [0.91, 0.97, 1.0, ...] â†’ ã‚ãšã‹ã—ã‹å­¦ç¿’ã•ã‚Œã¦ã„ãªã„
- final_conv: diagonal=0.98 â†’ ã»ã¼åˆæœŸå€¤ï¼ˆ1.0ï¼‰ã®ã¾ã¾
- out_proj: norm=0.463 â†’ åˆæœŸå€¤ã‹ã‚‰-18%ï¼ˆãªãœæ¸›å°‘ï¼Ÿï¼‰

---

## 5. Phase 1æˆåŠŸã®æœ¬è³ªçš„ç†ç”±

### 5.1 ã‚·ãƒ³ãƒ—ãƒ«ã•ã®å‹åˆ©

**æœ€å°é™ã®å±¤**:
```python
# Phase 1: ãŸã£ãŸ1å±¤
audio = out_proj(rvq_output)

# Phase A-v2: 4å±¤
audio = out_proj(final_conv(post_scale * rvq_output))
```

**ã‚ªãƒƒã‚«ãƒ ã®å‰ƒåˆ€**:
- ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¢ãƒ‡ãƒ«ã»ã©å­¦ç¿’ãŒå®¹æ˜“
- å±¤ãŒå°‘ãªã„ = å‹¾é…ãŒç›´æ¥å±Šã
- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°ãŒå°‘ãªã„ = éå­¦ç¿’ãƒªã‚¹ã‚¯ä½

### 5.2 æ¥µç«¯ã«å°ã•ã„out_projã®å½¹å‰²

**Phase 1ã®out_proj norm: 0.042ã®æ„å‘³**:

```python
# åˆæœŸåŒ–æ™‚ï¼ˆKaiming uniformï¼‰:
# fan_in = 40, fan_out = 1
# æœŸå¾…å€¤: sqrt(2/40) â‰ˆ 0.22

# å­¦ç¿’å¾Œ:
# norm = 0.042 (åˆæœŸå€¤ã®19%)

# ã¤ã¾ã‚Š:
# out_projã¯å­¦ç¿’ä¸­ã«**å¤§å¹…ã«ç¸®å°**ã—ãŸ
# RVQå‡ºåŠ›ï¼ˆstdâ‰ˆ1.0ï¼‰ã‚’ audioï¼ˆRMSâ‰ˆ0.075ï¼‰ã«å†™åƒã™ã‚‹ãŸã‚
# â†’ weight â‰ˆ 0.075 ãŒé©åˆ‡
# â†’ norm â‰ˆ sqrt(0.075^2 * 40) â‰ˆ 0.047
# â†’ å®Ÿæ¸¬å€¤0.042ã¨ä¸€è‡´ï¼
```

**Phase 1ã®out_projã¯ç†è«–å€¤é€šã‚Šå­¦ç¿’ã•ã‚Œã¦ã„ã‚‹**

### 5.3 RMS LossãŒãªã„æ–¹ãŒè‰¯ã„ï¼Ÿ

**é€†èª¬çš„ç™ºè¦‹**:
- Phase 1: RMS Lossãªã— â†’ Audio RMS = 0.080 (ç›®æ¨™0.075ã®107%)
- Phase A-v2: RMS Lossã‚ã‚Š â†’ Audio RMS = 0.0044 (ç›®æ¨™ã®6%)

**ä»®èª¬**:
```python
# RMS LossãŒãªã„å ´åˆ:
# - ã‚¹ã‚±ãƒ¼ãƒ«ã¯STFT/L1 Lossã‹ã‚‰æš—é»™çš„ã«å­¦ç¿’
# - éŸ³è³ªã¨ã‚¹ã‚±ãƒ¼ãƒ«ãŒåŒæ™‚ã«æœ€é©åŒ–
# - è‡ªç„¶ã«ãƒãƒ©ãƒ³ã‚¹

# RMS LossãŒã‚ã‚‹å ´åˆ:
# - ã‚¹ã‚±ãƒ¼ãƒ«ç›£ç£ãŒæ˜ç¤ºçš„
# - ã—ã‹ã—å‹¾é…è¦æ¨¡ãŒå°ã•ã„ï¼ˆ1æ¬¡å…ƒ vs æ•°ç™¾æ¬¡å…ƒï¼‰
# - ä»–ã®Lossã«åœ§å€’ã•ã‚Œã‚‹
# - ã¾ãŸã¯ã€å±¤ãŒå¤šã™ãã¦å‹¾é…ãŒå±Šã‹ãªã„
```

---

## 6. ä¿®æ­£æ–¹é‡ã®å†æ¤œè¨

### 6.1 å½“åˆã®ææ¡ˆï¼ˆPhase A-v3: ã‚¹ã‚±ãƒ¼ãƒ«æ˜ç¤ºä¼æ’­ï¼‰

**å®Ÿè£…æ¡ˆ**:
```python
# ã‚¹ã‚±ãƒ¼ãƒ«ä¿å­˜
pre_norm_std = x_for_rvq.std(dim=-1, keepdim=True)
x_for_rvq = x_for_rvq / (pre_norm_std + 1e-5)

quantized, rvq_loss, codes = self.rvq(x_for_rvq)

# ã‚¹ã‚±ãƒ¼ãƒ«å¾©å…ƒ
quantized = quantized * pre_norm_std.squeeze(-1).unsqueeze(1)
```

**å•é¡Œç‚¹**:
- Phase 1ã¨ã®æ¯”è¼ƒã‹ã‚‰ã€**æ­£è¦åŒ–è‡ªä½“ã¯å•é¡Œã§ã¯ãªã„**
- ã‚¹ã‚±ãƒ¼ãƒ«æ˜ç¤ºä¼æ’­ã‚’è¿½åŠ ã—ã¦ã‚‚ã€**å¤šå±¤æ§‹é€ ã®å•é¡Œã¯è§£æ±ºã—ãªã„**
- ã•ã‚‰ã«è¤‡é›‘åŒ–ã™ã‚‹å¯èƒ½æ€§

### 6.2 æ–°ã—ã„ææ¡ˆ: Phase 1ã¸ã®å›å¸°ï¼ˆã‚·ãƒ³ãƒ—ãƒ«åŒ–ï¼‰

**Option A: å®Œå…¨ãªPhase 1å›å¸°**
```python
# decoder.py
# æ­£è¦åŒ–ã¯ç¶­æŒ
x_for_rvq = normalize(self.pre_rvq_conv(x))

# RVQã¯ãã®ã¾ã¾
quantized, rvq_loss, codes = self.rvq(x_for_rvq)

# â˜…post_scale, final_convã‚’å‰Šé™¤
# audio = self.out_proj(quantized.transpose(1, 2)).squeeze(1)
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- Phase 1ã®æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ã«æˆ»ã‚‹
- ã‚·ãƒ³ãƒ—ãƒ«ã€å‹¾é…ãŒç›´æ¥å±Šã
- å®Ÿè¨¼æ¸ˆã¿ã®å®‰å®šæ€§

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- ã›ã£ã‹ãã®STE fixã€IdentityåˆæœŸåŒ–ãŒç„¡é§„ã«
- Progressive RVQã®åŠ¹æœã‚‚å¤±ã‚ã‚Œã‚‹å¯èƒ½æ€§

### 6.3 æ–°ã—ã„ææ¡ˆ: ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ï¼ˆL2æ­£è¦åŒ– + ã‚·ãƒ³ãƒ—ãƒ«æ§‹é€ ï¼‰

**Option B: DACæ–¹å¼ã¸ã®ç§»è¡Œ**
```python
# decoder.py
x_for_rvq = self.pre_rvq_conv(x)
x_for_rvq = F.normalize(x_for_rvq.transpose(1, 2), p=2, dim=-1)  # L2æ­£è¦åŒ–

# rvq.py
# Codebookã‚‚ L2æ­£è¦åŒ–
codebook_normalized = F.normalize(codebook, p=2, dim=-1)
residual_normalized = F.normalize(residual, p=2, dim=-1)

# ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦ã§é‡å­åŒ–
similarity = residual_normalized @ codebook_normalized.t()
indices = similarity.argmax(dim=-1)

# â˜…post_scale, final_convã¯å‰Šé™¤
# â˜…ã‚·ãƒ³ãƒ—ãƒ«ã« out_proj ã®ã¿
audio = self.out_proj(quantized.transpose(1, 2)).squeeze(1)
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹æº–æ‹ ï¼ˆDAC, Improved VQGANï¼‰
- Codebookåˆ©ç”¨ç‡å‘ä¸ŠãŒæœŸå¾…ã§ãã‚‹
- è¨“ç·´å®‰å®šæ€§ã®å‘ä¸Š
- ã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹é€ 

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- L2æ­£è¦åŒ–ã¸ã®ç§»è¡Œãƒªã‚¹ã‚¯
- æ—¢å­˜ã®çŸ¥è¦‹ãŒä½¿ãˆãªã„å¯èƒ½æ€§

### 6.4 æ–°ã—ã„ææ¡ˆ: æœ€å°é™ã®ä¿®æ­£ï¼ˆpost_scaleå‰Šé™¤ã®ã¿ï¼‰

**Option C: æ®µéšçš„ã‚·ãƒ³ãƒ—ãƒ«åŒ–**
```python
# Phase 1ã«è¿‘ã¥ã‘ã‚‹ãŒã€final_convã¯ç¶­æŒ
# rvq.py
# â˜…post_scale/post_biasã‚’å‰Šé™¤

for q_idx, codebook in enumerate(active_codebooks):
    # é‡å­åŒ–ï¼ˆL2è·é›¢ï¼‰
    embeds = find_nearest(residual, codebook)

    # â˜…post_scaleã¯å‰Šé™¤ã€ç›´æ¥åŠ ç®—
    quantized_sum += embeds
    residual -= embeds

# final_convã¯ç¶­æŒï¼ˆIdentityåˆæœŸåŒ–ã®æ©æµï¼‰
quantized_final = self.final_conv(quantized_sum.transpose(1, 2)).transpose(1, 2)

# out_projã§å‡ºåŠ›
audio = self.out_proj(quantized_final.transpose(1, 2)).squeeze(1)
```

**æ§‹é€ **:
```
RVQ â†’ final_conv (Identity) â†’ out_proj
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- Phase 1ã‚ˆã‚Š1å±¤ã ã‘å¤šã„ï¼ˆè¨±å®¹ç¯„å›²ï¼‰
- final_convã®IdentityåˆæœŸåŒ–ã¯æ®‹ã‚‹
- post_scale/biasã®å­¦ç¿’å¤±æ•—ã‚’å›é¿

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- final_convã®å¿…è¦æ€§ãŒä¸æ˜
- Phase 1ã»ã©ã‚·ãƒ³ãƒ—ãƒ«ã§ã¯ãªã„

---

## 7. æ¨å¥¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

### å„ªå…ˆåº¦1: Option Bï¼ˆDACæ–¹å¼ã¸ã®ç§»è¡Œï¼‰

**ç†ç”±**:
1. âœ… **å­¦è¡“çš„è£ä»˜ã‘**: Improved VQGAN, DAC, è¤‡æ•°ã®è«–æ–‡ã§å®Ÿè¨¼
2. âœ… **ã‚·ãƒ³ãƒ—ãƒ«**: `rvq â†’ out_proj` ã®ã¿
3. âœ… **Codebookåˆ©ç”¨ç‡å‘ä¸Š**: Perplexityä½ä¸‹å•é¡Œã‚‚è§£æ±ºå¯èƒ½
4. âœ… **Phase 1ã®æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¸è¥²**: ã‚·ãƒ³ãƒ—ãƒ«æ§‹é€ 

**å®Ÿè£…æ‰‹é †**:
1. `decoder.py`: Z-score â†’ L2æ­£è¦åŒ–ã«å¤‰æ›´
2. `rvq.py`: Codebookã‚‚ L2æ­£è¦åŒ–
3. `rvq.py`: post_scale/bias, final_convã‚’å‰Šé™¤
4. `rvq.py`: è·é›¢è¨ˆç®—ã‚’ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦ã«å¤‰æ›´

**æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ**:
- Audio RMS: 0.075 Â± 20% (Phase 1ã¨åŒç­‰)
- Perplexity: â‰¥10 (Codebookåˆ©ç”¨ç‡å‘ä¸Š)
- è¨“ç·´å®‰å®šæ€§: Phase 1ä»¥ä¸Š

### å„ªå…ˆåº¦2: Option Aï¼ˆPhase 1å®Œå…¨å›å¸°ï¼‰

**ç†ç”±**:
- æœ€ã‚‚å®‰å…¨ï¼ˆå®Ÿè¨¼æ¸ˆã¿ï¼‰
- å®Ÿè£…ãŒç°¡å˜ï¼ˆpost_scaleç­‰ã‚’å‰Šé™¤ã™ã‚‹ã ã‘ï¼‰

**æ¬ ç‚¹**:
- Codebookåˆ©ç”¨ç‡ã¯æ”¹å–„ã—ãªã„ï¼ˆPerplexity 5-8ã®ã¾ã¾ï¼‰
- ãƒ¢ã‚¹ã‚­ãƒ¼ãƒˆãƒ¼ãƒ³å•é¡Œã¯æ®‹ã‚‹

### å„ªå…ˆåº¦3: Option Cï¼ˆæ®µéšçš„ã‚·ãƒ³ãƒ—ãƒ«åŒ–ï¼‰

**ç†ç”±**:
- ä¸­é–“çš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

**æ¬ ç‚¹**:
- final_convã®å¿…è¦æ€§ãŒä¸æ˜
- ç†è«–çš„è£ä»˜ã‘ãŒå¼±ã„

---

## 8. æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### Phase Bå€™è£œ: DACæ–¹å¼å®Ÿè£…

**å®Ÿè£…ã‚¿ã‚¹ã‚¯**:
1. [ ] `decoder.py`: L2æ­£è¦åŒ–ã¸ã®å¤‰æ›´
2. [ ] `rvq.py`: Codebookã®L2æ­£è¦åŒ–
3. [ ] `rvq.py`: ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦ãƒ™ãƒ¼ã‚¹ã®è·é›¢è¨ˆç®—
4. [ ] `rvq.py`: post_scale/bias, final_convã®å‰Šé™¤
5. [ ] `losses.py`: RMS Lossã®å‰Šé™¤ï¼ˆPhase 1ã«å€£ã†ï¼‰
6. [ ] `configs/`: Phase Bç”¨ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

**æ¤œè¨¼è¨ˆç”»**:
- 2K step: Audio RMSç¢ºèªï¼ˆç›®æ¨™: 0.06-0.09ï¼‰
- 5K step: Perplexityç¢ºèªï¼ˆç›®æ¨™: â‰¥10ï¼‰
- Phase 1, Phase A-v2ã¨ã®æ¯”è¼ƒ

**æˆåŠŸåŸºæº–**:
- âœ… Audio RMS: 0.075 Â± 20%
- âœ… Perplexity Q0: â‰¥10
- âœ… ãƒ¢ã‚¹ã‚­ãƒ¼ãƒˆãƒ¼ãƒ³æ”¹å–„ï¼ˆä¸»è¦³è©•ä¾¡ï¼‰

---

## 9. Lessons Learned

### è¨­è¨ˆåŸå‰‡

1. **ã‚·ãƒ³ãƒ—ãƒ«ã•ã‚’å„ªå…ˆã›ã‚ˆ**
   - å±¤ãŒå°‘ãªã„ = å‹¾é…ãŒå±Šã = å­¦ç¿’ã—ã‚„ã™ã„
   - è¤‡é›‘ã•ã¯æœ€å¾Œã®æ‰‹æ®µ

2. **å®Ÿè¨¼æ¸ˆã¿ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«å¾“ãˆ**
   - DAC/EnCodecã®L2/RMSæ­£è¦åŒ–ã¯ç†ç”±ãŒã‚ã‚‹
   - Z-scoreæ­£è¦åŒ–ã¯éæ¨™æº–

3. **ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚µã‚¤ã‚º â‰  åŠ¹æœ**
   - Phase 1: out_proj norm=0.042 â†’ æˆåŠŸ
   - Phase A-v2: out_proj norm=0.463 (11å€) â†’ å¤±æ•—

4. **Lossè¿½åŠ ã¯æ…é‡ã«**
   - RMS Lossã¯é€†åŠ¹æœã ã£ãŸå¯èƒ½æ€§
   - æš—é»™çš„å­¦ç¿’ã®æ–¹ãŒè‰¯ã„å ´åˆã‚‚ã‚ã‚‹

5. **Phase 1ã®æˆåŠŸã‚’è»½è¦–ã™ã‚‹ãª**
   - ã€Œãƒ¢ã‚¹ã‚­ãƒ¼ãƒˆãƒ¼ãƒ³ãŒã‚ã‚‹ã€ã ã‘ã§å¦å®šã›ãš
   - ãªãœæˆåŠŸã—ãŸã®ã‹ã‚’ç†è§£ã™ã‚‹

---

## 10. èª¿æŸ»çµè«–

### Phase A-v2å¤±æ•—ã®çœŸå› 

âŒ **èª¤ã£ãŸä»®èª¬**: Pre-RVQæ­£è¦åŒ–ãŒã‚¹ã‚±ãƒ¼ãƒ«ã‚’ç ´å£Š
âœ… **æ­£ã—ã„ç†è§£**: æ­£è¦åŒ– + å¤šå±¤æ§‹é€  + å‹¾é…å¸Œé‡ˆ

### Phase 1æˆåŠŸã®çœŸå› 

âŒ **èª¤ã£ãŸä»®èª¬**: ãŸã¾ãŸã¾é‹ãŒè‰¯ã‹ã£ãŸ
âœ… **æ­£ã—ã„ç†è§£**: ã‚·ãƒ³ãƒ—ãƒ«æ§‹é€  + é©åˆ‡ãªout_projå­¦ç¿’ + Lossãƒãƒ©ãƒ³ã‚¹

### æ¬¡ã®ä¸€æ‰‹

ğŸ¯ **Phase B: DACæ–¹å¼ï¼ˆL2æ­£è¦åŒ– + ã‚·ãƒ³ãƒ—ãƒ«æ§‹é€ ï¼‰**
- å­¦è¡“çš„è£ä»˜ã‘ã‚ã‚Š
- Phase 1ã®æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³è¸è¥²
- Codebookåˆ©ç”¨ç‡å‘ä¸Šã‚‚æœŸå¾…

---

**Appendix: å‚è€ƒå®Ÿè£…ã‚³ãƒ¼ãƒ‰**

### DACæ–¹å¼ã®L2æ­£è¦åŒ–RVQ

```python
class L2NormalizedRVQ(nn.Module):
    def forward(self, x):
        # x: (B, T, C)
        residual = F.normalize(x, p=2, dim=-1)  # L2æ­£è¦åŒ–
        quantized_sum = torch.zeros_like(x)
        codes = []
        commitment_loss = 0.0

        for codebook in self.codebooks:
            # ã‚³ãƒ¼ãƒ‰ãƒ–ãƒƒã‚¯ã‚‚L2æ­£è¦åŒ–
            codebook_norm = F.normalize(codebook, p=2, dim=-1)

            # ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦ã§æœ€è¿‘å‚æ¢ç´¢
            similarity = torch.einsum('btc,kc->btk', residual, codebook_norm)
            indices = similarity.argmax(dim=-1)
            codes.append(indices)

            # é‡å­åŒ–æ¸ˆã¿ãƒ™ã‚¯ãƒˆãƒ«å–å¾—
            embeds = F.embedding(indices, codebook_norm)

            # STEï¼ˆæ­£è¦åŒ–ç©ºé–“ã§ï¼‰
            embeds_st = residual + (embeds - residual).detach()
            quantized_sum = quantized_sum + embeds_st

            # æ¬¡ã®æ®‹å·®ï¼ˆæ­£è¦åŒ–ç©ºé–“ã§ï¼‰
            residual = residual - embeds
            residual = F.normalize(residual, p=2, dim=-1)

            # Commitment loss
            commitment_loss += (residual.detach() - embeds).pow(2).mean()

        return quantized_sum, commitment_loss, codes
```
